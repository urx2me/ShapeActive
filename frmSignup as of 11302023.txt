Imports System.Text.RegularExpressions
Imports MySql.Data.MySqlClient

Public Class frmSignup
    Sub insertLogs()
        Dim myConnectionx As MySqlConnection
        Dim myCommandx As MySqlCommand

        ' Make sure to replace these with your actual database connection information
        Dim connectionString As String = "Server=localhost;Database=shapeactive;Uid=root;Pwd=nics1108;"

        myConnectionx = New MySqlConnection(connectionString)

        Try
            myConnectionx.Open()

            ' Use parameters to prevent SQL injection
            Dim query As String = "INSERT INTO tblUsers (dname, demail, dpassword, dage, dheight, dcurrentWeight, ttimestamp) VALUES (@dname, @demail, @dpassword, @dage, @dheight, @dcurrentWeight, @ttimestamp)"
            myCommandx = New MySqlCommand(query, myConnectionx)

            ' Replace Environ with actual input source (e.g., TextBox.Text)
            myCommandx.Parameters.AddWithValue("@dname", txtName.Text)
            myCommandx.Parameters.AddWithValue("@demail", txtEmail.Text)
            myCommandx.Parameters.AddWithValue("@dpassword", txtPassword.Text)
            myCommandx.Parameters.AddWithValue("@dheight", txtHeight.Text)
            myCommandx.Parameters.AddWithValue("@dage", txtAge.Text)
            myCommandx.Parameters.AddWithValue("@dcurrentWeight", txtCurrentWeight.Text)
            myCommandx.Parameters.AddWithValue("@ttimestamp", DateTime.Now)


            myCommandx.ExecuteNonQuery()

            MsgBox("Item has been saved. Refreshing page.", vbOK, "Success")
        Catch ex As Exception
            MsgBox(ex.Message)
        Finally
            myConnectionx.Close()
        End Try
    End Sub


    Private Sub btnCreate_Click(sender As Object, e As EventArgs) Handles btnCreate.Click
        insertLogs()
        Me.Hide()
        frmLogin.Show()
    End Sub


    Private Sub txtAge_TextChanged(sender As Object, e As EventArgs) Handles txtAge.TextChanged
        txtAge.MaxLength = 3
        ' Remove non-numeric characters
        txtAge.Text = New String(txtAge.Text.Where(Function(c) Char.IsDigit(c)).ToArray())
    End Sub

    Private Sub txtCurrentWeight_KeyPress(sender As Object, e As KeyPressEventArgs) Handles txtCurrentWeight.KeyPress
        txtCurrentWeight.MaxLength = 4

        ' Allow only digits, backspace, and the decimal point
        If Not Char.IsDigit(e.KeyChar) AndAlso e.KeyChar <> ControlChars.Back AndAlso e.KeyChar <> "." Then
            e.Handled = True
        End If

        ' Allow only one decimal point
        Dim textBox = TryCast(sender, TextBox)
        If textBox IsNot Nothing AndAlso e.KeyChar = "." AndAlso (textBox.Text.Contains(".") OrElse textBox.Text.Length >= 5) Then
            e.Handled = True
        End If

        ' Convert whole number to decimal if a decimal point is entered
        If textBox IsNot Nothing AndAlso e.KeyChar = "." AndAlso Not textBox.Text.Contains(".") Then
            Dim cursorPosition = textBox.SelectionStart
            textBox.Text = textBox.Text.Insert(cursorPosition, ".0")
            textBox.SelectionStart = cursorPosition + 2  ' Set the cursor after the inserted ".0"
            e.Handled = True
        End If
    End Sub

    Private Sub txtPassword_TextChanged(sender As Object, e As EventArgs) Handles txtPassword.TextChanged
        txtPassword.MaxLength = 20
        txtPassword.UseSystemPasswordChar = True
    End Sub

    Private Sub txtEmail_TextChanged(sender As Object, e As EventArgs) Handles txtEmail.TextChanged
        txtEmail.MaxLength = 30
    End Sub

    Private Sub txtName_TextChanged(sender As Object, e As EventArgs) Handles txtName.TextChanged
        txtName.MaxLength = 20
    End Sub

    Private Sub txtHeight_KeyPress(sender As Object, e As KeyPressEventArgs) Handles txtHeight.KeyPress
        txtHeight.MaxLength = 3

        ' Allow only digits, backspace, and the decimal point
        If Not Char.IsDigit(e.KeyChar) AndAlso e.KeyChar <> ControlChars.Back AndAlso e.KeyChar <> "." Then
            e.Handled = True
        End If

        ' Allow only one decimal point
        Dim textBox = TryCast(sender, TextBox)
        If textBox IsNot Nothing AndAlso e.KeyChar = "." AndAlso (textBox.Text.Contains(".") OrElse textBox.Text.Length >= 5) Then
            e.Handled = True
        End If

        ' Convert whole number to decimal if a decimal point is entered
        If textBox IsNot Nothing AndAlso e.KeyChar = "." AndAlso Not textBox.Text.Contains(".") Then
            Dim cursorPosition = textBox.SelectionStart
            textBox.Text = textBox.Text.Insert(cursorPosition, ".0")
            textBox.SelectionStart = cursorPosition + 2  ' Set the cursor after the inserted ".0"
            e.Handled = True
        End If
    End Sub
End Class