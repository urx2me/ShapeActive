Imports MySql.Data.MySqlClient

Public Class frmGoals
    ' Set up your MySQL connection string
    Dim connectionString As String = "server=localhost;user id=root;password=Charles-061803;database=shapeactive"
    Dim connection As New MySqlConnection(connectionString)

    Private Sub frmGoals_Load(sender As Object, e As EventArgs) Handles MyBase.Load
        ' Load the user's current weight and set the current date when the form loads
        LoadCurrentWeight()
        SetCurrentDate()
    End Sub

    Private Sub LoadCurrentWeight()
        ' Query the database to get the user's current weight
        Dim query As String = "SELECT dcurrentWeight FROM tblusers ORDER BY duserId DESC LIMIT 1"

        Using cmd As New MySqlCommand(query, connection)
            Try
                connection.Open()
                Dim reader As MySqlDataReader = cmd.ExecuteReader()

                If reader.Read() Then
                    ' Display the current weight in the txtCurrentWeight TextBox
                    txtCurrentWeight.Text = reader("dcurrentWeight").ToString()
                Else
                    MessageBox.Show("No user data found.")
                End If
            Catch ex As Exception
                MessageBox.Show("Error loading current weight: " & ex.Message)
            Finally
                connection.Close()
            End Try
        End Using
    End Sub

    Private Sub SetCurrentDate()
        ' Set the current date in the txtStartDate TextBox
        txtStartDate.Text = DateTime.Now.ToString("yyyy-MM-dd")
    End Sub

    Private Sub btnSave_Click(sender As Object, e As EventArgs) Handles btnSave.Click
        ' Update the user's weight in tblusers and insert into tblgoals
        Dim newWeight As Double
        Dim goalType As String = cmbGoalType.SelectedItem.ToString()
        Dim targetWeight As Double
        Dim targetDate As Date

        If Double.TryParse(txtCurrentWeight.Text, newWeight) AndAlso
           Double.TryParse(txtTargetWeight.Text, targetWeight) AndAlso
           Date.TryParse(dtpTargetDate.Text, targetDate) Then
            ' Perform the update in tblusers and get the auto-incremented userId
            Dim userId As Integer = GetLatestUserId()

            If userId <> -1 Then
                ' Perform the insert into tblgoals using the obtained userId
                UpdateGoals(userId, newWeight, goalType, targetWeight, targetDate)

                ' Reload the current weight and set the current date to reflect the changes
                LoadCurrentWeight()
                SetCurrentDate()

                ' Clear the input controls
                cmbGoalType.SelectedIndex = -1
                txtTargetWeight.Clear()

                ' Optionally close the form after saving
                ' Me.Close()
            Else
                MessageBox.Show("Error updating user weight.")
            End If
        Else
            MessageBox.Show("Please enter valid weight, target weight, and target date.")
        End If
    End Sub

    Private Function GetLatestUserId() As Integer
        ' Retrieve the latest user ID from tblusers
        Dim query As String = "SELECT duserId FROM tblusers ORDER BY duserId DESC LIMIT 1"

        Using cmd As New MySqlCommand(query, connection)
            Try
                connection.Open()
                Dim userId As Object = cmd.ExecuteScalar()

                If userId IsNot Nothing Then
                    Return Convert.ToInt32(userId)
                Else
                    MessageBox.Show("No user data found.")
                    Return -1
                End If
            Catch ex As Exception
                MessageBox.Show("Error retrieving user ID: " & ex.Message)
                Return -1
            Finally
                connection.Close()
            End Try
        End Using
    End Function

    Private Sub UpdateGoals(userId As Integer, newWeight As Double, goalType As String, targetWeight As Double, targetDate As Date)
        ' Insert a new record into tblgoals with the updated weight, userId, and other goal details
        Dim query As String = "INSERT INTO tblgoals (duserId, dgoalType, dcurrentWeight, dtargetWeight, dgoalStart, dgoalEnd) " &
                              "VALUES (@userId, @goalType, @newWeight, @targetWeight, @targetDate, @targetDate)"

        Using cmd As New MySqlCommand(query, connection)
            cmd.Parameters.AddWithValue("@userId", userId)
            cmd.Parameters.AddWithValue("@goalType", goalType)
            cmd.Parameters.AddWithValue("@newWeight", newWeight)
            cmd.Parameters.AddWithValue("@targetWeight", targetWeight)
            cmd.Parameters.AddWithValue("@targetDate", targetDate.ToString("yyyy-MM-dd"))

            Try
                connection.Open()
                cmd.ExecuteNonQuery()
            Catch ex As Exception
                MessageBox.Show("Error updating goals: " & ex.Message)
            Finally
                connection.Close()
            End Try
        End Using
    End Sub

    Private Sub btnExit_Click(sender As Object, e As EventArgs) Handles btnExit.Click
        ' Close the form when the exit button is pressed
        Me.Close()
    End Sub

Private Sub HomeToolStripMenuItem_Click(sender As Object, e As EventArgs) Handles HomeToolStripMenuItem.Click
    Close()
End Sub

Private Sub ProfileToolStripMenuItem_Click(sender As Object, e As EventArgs) Handles ProfileToolStripMenuItem.Click
    frmProfile.Show()
    Close()
End Sub

Private Sub LogoutToolStripMenuItem_Click(sender As Object, e As EventArgs) Handles LogoutToolStripMenuItem.Click
    frmLogin.Show()
    Me.Close()
End Sub

Private Sub ActivitiesToolStripMenuItem_Click(sender As Object, e As EventArgs) Handles ActivitiesToolStripMenuItem.Click
    frmActivities.Show()
    Close()
End Sub

Private Sub DietToolStripMenuItem_Click(sender As Object, e As EventArgs) Handles DietToolStripMenuItem.Click
    frmDiet.Show()
    Close()
End Sub

Private Sub AchievementToolStripMenuItem_Click(sender As Object, e As EventArgs) Handles AchievementToolStripMenuItem.Click
    frmAchievements.Show()
    Close()
End Sub
End Class
